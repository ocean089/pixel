<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>一筆畫遊戲</title>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background-color: #fef6e4;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    #home, #game, #result {
      display: none;
      padding: 20px;
    }
    .active {
      display: block !important;
    }
    button {
      font-size: 1.2rem;
      padding: 12px 24px;
      margin: 12px;
      border: none;
      border-radius: 10px;
      background-color: #f582ae;
      color: white;
      cursor: pointer;
    }
    canvas {
      background-color: #fff;
      border: 2px solid #8bd3dd;
      margin-top: 20px;
      max-width: 90vw;
      height: auto;
      touch-action: none;
    }
    #title {
      font-size: 1.6rem;
      font-weight: bold;
      margin-top: 10px;
    }
    #instructions {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    #timer {
      font-size: 1.3rem;
      color: #333;
    }
    #result h2 {
      font-size: 2rem;
      color: #f582ae;
      animation: pop 1s ease-in-out infinite alternate;
    }
    @keyframes pop {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }
  </style>
</head>
<body>
<div id="home" class="active">
  <h1 style="font-size: 2rem; margin-top: 30px;">一筆畫遊戲</h1>
  <p>請選擇關卡開始挑戰：</p>
  <div id="levelButtons"></div>
</div>
<div id="game">
  <div id="title"></div>
  <div id="instructions">請用手指從一點滑到另一點來畫線，不能重複喔！</div>
  <div id="timer">時間：00:00</div>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <br />
  <button onclick="resetGame()">重新開始</button>
<br />
<button onclick="goHome()">回首頁</button>

</div>
<div id="result">
  <h2>完成了！</h2>
  <p id="timeUsed"></p>
  <div id="stars" style="font-size: 2rem; color: gold; margin-top: 1rem;"></div>
  <button onclick="goHome()">回首頁</button>
  <button onclick="nextLevel()">下一關</button>
</div>
<audio id="successSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e8cd8b6a08.mp3"></audio>
<audio id="failSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_20684fce18.mp3"></audio>
<script>
const LEVELS = [
  {
    "name": "\u4e09\u89d2\u5f62",
    "points": [
      [
        0.5,
        0.1
      ],
      [
        0.2,
        0.8
      ],
      [
        0.8,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        0
      ]
    ]
  },
  {
    "name": "\u6b63\u65b9\u5f62",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.8,
        0.2
      ],
      [
        0.8,
        0.8
      ],
      [
        0.2,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        0
      ]
    ]
  },
  {
    "name": "\u4e94\u8292\u661f",
    "points": [
      [
        0.5,
        0.1
      ],
      [
        0.8,
        0.35
      ],
      [
        0.65,
        0.85
      ],
      [
        0.35,
        0.85
      ],
      [
        0.2,
        0.35
      ]
    ],
    "lines": [
      [
        0,
        2
      ],
      [
        2,
        4
      ],
      [
        4,
        1
      ],
      [
        1,
        3
      ],
      [
        3,
        0
      ]
    ]
  },
  {
    "name": "\u623f\u5b50",
    "points": [
      [
        0.2,
        0.8
      ],
      [
        0.8,
        0.8
      ],
      [
        0.8,
        0.4
      ],
      [
        0.2,
        0.4
      ],
      [
        0.5,
        0.1
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        0
      ],
      [
        3,
        4
      ],
      [
        4,
        2
      ]
    ]
  },
  {
    "name": "\u4fe1\u5c01",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.8,
        0.2
      ],
      [
        0.8,
        0.8
      ],
      [
        0.2,
        0.8
      ],
      [
        0.5,
        0.5
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        0
      ],
      [
        0,
        4
      ],
      [
        1,
        4
      ],
      [
        2,
        4
      ],
      [
        3,
        4
      ]
    ]
  },
  {
    "name": "\u947d\u77f3",
    "points": [
      [
        0.5,
        0.1
      ],
      [
        0.9,
        0.5
      ],
      [
        0.5,
        0.9
      ],
      [
        0.1,
        0.5
      ],
      [
        0.5,
        0.5
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        0
      ],
      [
        0,
        4
      ],
      [
        1,
        4
      ],
      [
        2,
        4
      ],
      [
        3,
        4
      ]
    ]
  },
  {
    "name": "\u5169\u5c71\u5f62",
    "points": [
      [
        0.1,
        0.8
      ],
      [
        0.3,
        0.4
      ],
      [
        0.5,
        0.8
      ],
      [
        0.7,
        0.4
      ],
      [
        0.9,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ]
    ]
  },
  {
    "name": "\u65e5\u5b57\u683c\u5c0d\u89d2\u7dda",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.8,
        0.2
      ],
      [
        0.8,
        0.8
      ],
      [
        0.2,
        0.8
      ],
      [
        0.2,
        0.5
      ],
      [
        0.8,
        0.5
      ],
      [
        0.5,
        0.2
      ],
      [
        0.5,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        0
      ],
      [
        4,
        5
      ],
      [
        6,
        7
      ],
      [
        0,
        4
      ],
      [
        4,
        3
      ],
      [
        1,
        5
      ],
      [
        5,
        2
      ],
      [
        0,
        6
      ],
      [
        6,
        1
      ],
      [
        3,
        7
      ],
      [
        7,
        2
      ]
    ]
  },
  {
    "name": "\u9f9c\u6bbc",
    "points": [
      [
        0.5,
        0.1
      ],
      [
        0.9,
        0.3
      ],
      [
        0.9,
        0.7
      ],
      [
        0.5,
        0.9
      ],
      [
        0.1,
        0.7
      ],
      [
        0.1,
        0.3
      ],
      [
        0.5,
        0.5
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ],
      [
        5,
        0
      ],
      [
        0,
        6
      ],
      [
        1,
        6
      ],
      [
        2,
        6
      ],
      [
        3,
        6
      ],
      [
        4,
        6
      ],
      [
        5,
        6
      ]
    ]
  },
  {
    "name": "\u87ba\u65cb\u6298\u7dda",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.8,
        0.2
      ],
      [
        0.8,
        0.8
      ],
      [
        0.6,
        0.8
      ],
      [
        0.6,
        0.4
      ],
      [
        0.4,
        0.4
      ],
      [
        0.4,
        0.6
      ],
      [
        0.6,
        0.6
      ],
      [
        0.6,
        0.9
      ],
      [
        0.2,
        0.9
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ],
      [
        5,
        6
      ],
      [
        6,
        7
      ],
      [
        7,
        8
      ],
      [
        8,
        9
      ]
    ]
  },
  {
    "name": "\u9583\u96fb\u92f8\u9f52",
    "points": [
      [
        0.1,
        0.3
      ],
      [
        0.3,
        0.3
      ],
      [
        0.2,
        0.5
      ],
      [
        0.4,
        0.5
      ],
      [
        0.3,
        0.7
      ],
      [
        0.5,
        0.7
      ],
      [
        0.4,
        0.9
      ],
      [
        0.6,
        0.9
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ],
      [
        5,
        6
      ],
      [
        6,
        7
      ]
    ]
  },
  {
    "name": "S\u578b\u66f2\u6298",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.5,
        0.2
      ],
      [
        0.5,
        0.5
      ],
      [
        0.2,
        0.5
      ],
      [
        0.2,
        0.8
      ],
      [
        0.5,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ]
    ]
  },
  {
    "name": "X\u5341\u5b57\u4ea4\u932f",
    "points": [
      [
        0.2,
        0.2
      ],
      [
        0.8,
        0.2
      ],
      [
        0.5,
        0.5
      ],
      [
        0.2,
        0.8
      ],
      [
        0.8,
        0.8
      ]
    ],
    "lines": [
      [
        0,
        4
      ],
      [
        4,
        1
      ],
      [
        1,
        3
      ],
      [
        3,
        0
      ],
      [
        0,
        2
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        2,
        4
      ]
    ]
  },
  {
    "name": "\u8718\u86db\u7db2",
    "points": [
      [
        0.5,
        0.2
      ],
      [
        0.7,
        0.3
      ],
      [
        0.8,
        0.5
      ],
      [
        0.7,
        0.7
      ],
      [
        0.5,
        0.8
      ],
      [
        0.3,
        0.7
      ],
      [
        0.2,
        0.5
      ],
      [
        0.3,
        0.3
      ],
      [
        0.5,
        0.5
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ],
      [
        5,
        6
      ],
      [
        6,
        7
      ],
      [
        7,
        0
      ],
      [
        0,
        8
      ],
      [
        1,
        8
      ],
      [
        2,
        8
      ],
      [
        3,
        8
      ],
      [
        4,
        8
      ],
      [
        5,
        8
      ],
      [
        6,
        8
      ],
      [
        7,
        8
      ]
    ]
  },
  {
    "name": "\u8ff7\u5bae\u6298\u7dda",
    "points": [
      [
        0.1,
        0.1
      ],
      [
        0.9,
        0.1
      ],
      [
        0.9,
        0.3
      ],
      [
        0.3,
        0.3
      ],
      [
        0.3,
        0.5
      ],
      [
        0.7,
        0.5
      ],
      [
        0.7,
        0.7
      ],
      [
        0.1,
        0.7
      ],
      [
        0.1,
        0.9
      ],
      [
        0.9,
        0.9
      ]
    ],
    "lines": [
      [
        0,
        1
      ],
      [
        1,
        2
      ],
      [
        2,
        3
      ],
      [
        3,
        4
      ],
      [
        4,
        5
      ],
      [
        5,
        6
      ],
      [
        6,
        7
      ],
      [
        7,
        8
      ],
      [
        8,
        9
      ]
    ]
  }
];
function flashLine(a, b) {
  const pts = LEVELS[currentLevel].points;
  const w = canvas.width;
  const h = canvas.height;
  let count = 0;
  const interval = setInterval(() => {
    if (count >= 4) {
      clearInterval(interval);
      draw(); // 恢復正常畫面
      return;
    }
    ctx.strokeStyle = (count % 2 === 0) ? "red" : "#fff";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(pts[a][0]*w, pts[a][1]*h);
    ctx.lineTo(pts[b][0]*w, pts[b][1]*h);
    ctx.stroke();
    count++;
  }, 150);
}

function tryDrawLine(a, b) {
  const level = LEVELS[currentLevel];
  const valid = level.lines.some(l =>
    (l[0] === a && l[1] === b) || (l[0] === b && l[1] === a));
  const exists = drawnLines.some(l =>
    (l[0] === a && l[1] === b) || (l[0] === b && l[1] === a));

  if (!valid) return; // 不合法線跳過

  if (exists) {
    playSound("failSound");
    flashLine(a, b);
    alert("這條線已經畫過了喔，不能重複畫！");
    return;
  }

  drawnLines.push([a,b]);
  draw();
  if (drawnLines.length === level.lines.length) {
    allowDraw = false;
    clearInterval(timerInterval);
    setTimeout(() => {
      const used = Date.now() - startTime;
      const min = Math.floor(used / 60000);
      const sec = Math.floor((used % 60000) / 1000);
      playSound("successSound");
      showStars(sec);
      recordResult(currentLevel, used, true);
      document.getElementById("timeUsed").textContent =
        `你用了 ${min} 分 ${sec} 秒完成這一關！`;
      showScreen("result");
    }, 1000);
  }
}

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let currentLevel = 0;
let drawnLines = [];
let startPointIndex = null;
let hoverPointIndex = null;
let startTime = null;
let timerInterval = null;
let allowDraw = true;

function showScreen(id) {
  document.querySelectorAll("div").forEach(d => d.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function goHome() {
  showScreen("home");
  renderLevelButtons();
}

function renderLevelButtons() {
  const container = document.getElementById("levelButtons");
  container.innerHTML = "";
  LEVELS.forEach((level, index) => {
    const btn = document.createElement("button");
    btn.textContent = `第${index + 1}關：${level.name}`;
    btn.onclick = () => startLevel(index);
    container.appendChild(btn);
  });
}

function resizeCanvas() {
  const size = Math.min(window.innerWidth * 0.9, 400);
  canvas.width = size;
  canvas.height = size;
  draw();
}

function startLevel(levelIndex) {
  currentLevel = levelIndex;
  drawnLines = [];
  startPointIndex = null;
  hoverPointIndex = null;
  allowDraw = true;
  clearInterval(timerInterval);
  document.getElementById("timer").textContent = "時間：00:00";
  startTime = null;
  document.getElementById("title").textContent = `第${levelIndex + 1}關：${LEVELS[levelIndex].name}`;
  showScreen("game");
  resizeCanvas();
}

function resetGame() {
  startLevel(currentLevel);
}

function nextLevel() {
  if (currentLevel + 1 < LEVELS.length) {
    startLevel(currentLevel + 1);
  } else {
    goHome();
  }
}

function draw() {
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  const level = LEVELS[currentLevel];
  const pts = level.points;

  // 底線
  ctx.strokeStyle = "#ccc";
  ctx.lineWidth = 2;
  level.lines.forEach(([a,b]) => {
    ctx.beginPath();
    ctx.moveTo(pts[a][0]*w, pts[a][1]*h);
    ctx.lineTo(pts[b][0]*w, pts[b][1]*h);
    ctx.stroke();
  });

  // 已畫線
  ctx.strokeStyle = "#f582ae";
  ctx.lineWidth = 4;
  drawnLines.forEach(([a,b]) => {
    ctx.beginPath();
    ctx.moveTo(pts[a][0]*w, pts[a][1]*h);
    ctx.lineTo(pts[b][0]*w, pts[b][1]*h);
    ctx.stroke();
  });

  // 點
  pts.forEach((p, i) => {
    ctx.beginPath();
    const r = (i === startPointIndex || i === hoverPointIndex) ? 14 : 10;
    ctx.arc(p[0]*w, p[1]*h, r, 0, Math.PI*2);
    ctx.fillStyle = "#8bd3dd";
    ctx.fill();
    ctx.strokeStyle = "#f582ae";
    ctx.lineWidth = 3;
    ctx.stroke();
  });
}

function getPointIndex(x, y) {
  const pts = LEVELS[currentLevel].points;
  const w = canvas.width;
  const h = canvas.height;
  for (let i = 0; i < pts.length; i++) {
    const px = pts[i][0]*w;
    const py = pts[i][1]*h;
    const dx = px - x;
    const dy = py - y;
    if (dx*dx + dy*dy < 400) return i;
  }
  return null;
}

canvas.addEventListener("touchstart", (e) => {
  if (!allowDraw) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  const index = getPointIndex(x, y);
  if (index !== null) {
    startPointIndex = index;
    if (!startTime) {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }
  }
});

canvas.addEventListener("touchmove", (e) => {
  if (!allowDraw || startPointIndex === null) return;
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  hoverPointIndex = getPointIndex(x, y);
  draw();

  if (hoverPointIndex !== null && hoverPointIndex !== startPointIndex) {
    tryDrawLine(startPointIndex, hoverPointIndex);
    startPointIndex = hoverPointIndex;
    hoverPointIndex = null;
  }
});

canvas.addEventListener("touchend", () => {
  if (!allowDraw) return;
  if (drawnLines.length < LEVELS[currentLevel].lines.length) {
    alert("Oops! 要一筆畫完成，不能抬起手喔！");
    resetGame();
  }
  startPointIndex = null;
  hoverPointIndex = null;
  draw();
});

function tryDrawLine(a, b) {
  const level = LEVELS[currentLevel];
  const valid = level.lines.some(l =>
    (l[0] === a && l[1] === b) || (l[0] === b && l[1] === a));
  const exists = drawnLines.some(l =>
    (l[0] === a && l[1] === b) || (l[0] === b && l[1] === a));
  if (valid && !exists) {
    drawnLines.push([a,b]);
    draw();
    if (drawnLines.length === level.lines.length) {
      allowDraw = false;
      clearInterval(timerInterval);
      setTimeout(() => {
        const used = Date.now() - startTime;
        const min = Math.floor(used / 60000);
        const sec = Math.floor((used % 60000) / 1000);
        document.getElementById("timeUsed").textContent =
          `你用了 ${min} 分 ${sec} 秒完成這一關！`;
        showScreen("result");
      }, 1000);
    }
  }
}

function updateTimer() {
  const elapsed = Date.now() - startTime;
  const min = Math.floor(elapsed / 60000);
  const sec = Math.floor((elapsed % 60000) / 1000);
  document.getElementById("timer").textContent = `時間：${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

window.onload = () => {
  renderLevelButtons();
  goHome();
  resizeCanvas();
};
</script>
</body>
</html>

</script>
</body>
</html>
