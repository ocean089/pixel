<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>華容道遊戲 - 第1關</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f0f0f0;
    }
    .board {
      width: 320px;
      height: 400px;
      margin: 20px auto;
      position: relative;
      border: 2px solid #000;
      background: #fff;
      touch-action: none;
    }
    .block {
      position: absolute;
      box-sizing: border-box;
      border: 1px solid #333;
      cursor: pointer;
      touch-action: none;
    }
    .btns {
      margin-top: 20px;
    }
    .rules {
      width: 90%;
      max-width: 400px;
      margin: 10px auto;
      padding: 10px;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 5px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>華容道 - 第1關</h1>

  <div class="rules">
    <strong>【遊戲規則】</strong>
    <ul>
      <li>將紅色的「曹操」滑塊移動到底部中間出口。</li>
      <li>使用滑鼠或手指拖曳滑塊移動（只能水平或垂直移動）。</li>
      <li>不能移出邊界，也不能重疊其他滑塊。</li>
    </ul>
  </div>

  <div id="game" class="board"></div>
  <div class="btns">
    <button onclick="resetBlocks()">重新開始</button>
  </div>

  <script>
    const CELL_SIZE = 80;
    const board = document.getElementById("game");
    let dragging = null;
    let offsetX = 0;
    let offsetY = 0;

    const initialBlocks = [
      { id: "caocao", x: 1, y: 0, w: 2, h: 2, color: "red" },
      { id: "guard1", x: 0, y: 0, w: 1, h: 2, color: "blue" },
      { id: "guard2", x: 3, y: 0, w: 1, h: 2, color: "blue" },
      { id: "soldier1", x: 0, y: 2, w: 1, h: 1, color: "green" },
      { id: "soldier2", x: 3, y: 2, w: 1, h: 1, color: "green" },
      { id: "horz1", x: 1, y: 2, w: 2, h: 1, color: "orange" },
    ];

    let blocks = [];

    function createBlocks() {
      board.innerHTML = "";
      blocks.forEach((b) => {
        const div = document.createElement("div");
        div.className = "block";
        div.style.left = b.x * CELL_SIZE + "px";
        div.style.top = b.y * CELL_SIZE + "px";
        div.style.width = b.w * CELL_SIZE + "px";
        div.style.height = b.h * CELL_SIZE + "px";
        div.style.backgroundColor = b.color;
        div.setAttribute("data-id", b.id);
        div.addEventListener("mousedown", (e) => startDrag(e, b));
        div.addEventListener("touchstart", (e) => startTouch(e, b));
        board.appendChild(div);
      });
    }

    function startDrag(e, block) {
      dragging = block;
      const rect = e.target.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      document.addEventListener("mousemove", drag);
      document.addEventListener("mouseup", stopDrag);
    }

    function drag(e) {
      if (!dragging) return;
      const newX = Math.round((e.clientX - board.offsetLeft - offsetX) / CELL_SIZE);
      const newY = Math.round((e.clientY - board.offsetTop - offsetY) / CELL_SIZE);
      if (newX < 0 || newX + dragging.w > 4 || newY < 0 || newY + dragging.h > 5) return;
      dragging.x = newX;
      dragging.y = newY;
      createBlocks();
      checkVictory();
    }

    function stopDrag() {
      dragging = null;
      document.removeEventListener("mousemove", drag);
      document.removeEventListener("mouseup", stopDrag);
    }

    function startTouch(e, block) {
      dragging = block;
      const touch = e.touches[0];
      const rect = e.target.getBoundingClientRect();
      offsetX = touch.clientX - rect.left;
      offsetY = touch.clientY - rect.top;
      document.addEventListener("touchmove", touchMove);
      document.addEventListener("touchend", stopTouch);
    }

    function touchMove(e) {
      if (!dragging) return;
      const touch = e.touches[0];
      const newX = Math.round((touch.clientX - board.offsetLeft - offsetX) / CELL_SIZE);
      const newY = Math.round((touch.clientY - board.offsetTop - offsetY) / CELL_SIZE);
      if (newX < 0 || newX + dragging.w > 4 || newY < 0 || newY + dragging.h > 5) return;
      dragging.x = newX;
      dragging.y = newY;
      createBlocks();
      checkVictory();
    }

    function stopTouch() {
      dragging = null;
      document.removeEventListener("touchmove", touchMove);
      document.removeEventListener("touchend", stopTouch);
    }

    function checkVictory() {
      const caocao = blocks.find((b) => b.id === "caocao");
      if (caocao.x === 1 && caocao.y === 3) {
        setTimeout(() => alert("🎉 通關成功！"), 100);
      }
    }

    function resetBlocks() {
      blocks = JSON.parse(JSON.stringify(initialBlocks));
      createBlocks();
    }

    resetBlocks();
  </script>
</body>
</html>
